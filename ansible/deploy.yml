---
- name: Deploy Notes App to AWS EKS with Karpenter
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    aws_region: "{{ aws_region | default('us-east-1') }}"
    cluster_name: "{{ cluster_name | default('notes-app') }}"
    
  tasks:
    - name: Apply Terraform infrastructure
      terraform:
        project_path: ../terraform
        state: present
        variables:
          aws_region: "{{ aws_region }}"
          cluster_name: "{{ cluster_name }}"
      register: terraform_output
      
    - name: Update Helm values with actual ECR URL
      replace:
        path: ../helm/values.yaml
        regexp: 'ACCOUNT_ID\.dkr\.ecr\.us-east-1\.amazonaws\.com/notes-web'
        replace: "{{ terraform_output.outputs.ecr_web_repository_url.value }}"
        
    - name: Get ECR login token
      shell: |
        aws ecr get-login-password --region {{ aws_region }} | \
        docker login --username AWS --password-stdin {{ terraform_output.outputs.ecr_web_repository_url.value | regex_replace('/.*') }}
      
    - name: Tag and push web application image to ECR
      shell: |
        docker tag notes_web:latest {{ terraform_output.outputs.ecr_web_repository_url.value }}:latest
        docker push {{ terraform_output.outputs.ecr_web_repository_url.value }}:latest
        
    - name: Update kubeconfig
      shell: |
        aws eks update-kubeconfig --region {{ aws_region }} --name {{ cluster_name }}
        
    - name: Install ArgoCD
      kubernetes.core.helm:
        name: argocd
        chart_ref: argo/argo-cd
        release_namespace: argocd
        create_namespace: true
        values:
          server:
            service:
              type: LoadBalancer
              
    - name: Wait for ArgoCD to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: argocd-server
        namespace: argocd
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 300
        
    - name: Commit updated Helm values to Git
      shell: |
        cd ..
        git add helm/values.yaml
        git commit -m "Update ECR URL after Terraform deployment" || true
        git push origin main || true
        
    - name: Apply ArgoCD application
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: notes-app
            namespace: argocd
          spec:
            project: default
            source:
              repoURL: "https://github.com/maroayman/depi-notes-app-gitops.git"
              targetRevision: HEAD
              path: helm
              helm:
                valueFiles:
                  - values.yaml
            destination:
              server: https://kubernetes.default.svc
              namespace: notes
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
              syncOptions:
                - CreateNamespace=true
